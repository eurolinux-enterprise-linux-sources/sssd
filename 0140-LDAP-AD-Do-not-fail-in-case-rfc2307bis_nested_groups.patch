From 294e82cb69500e12bbfef8a4b1a91c229352f7d6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fabiano=20Fid=C3=AAncio?= <fidencio@redhat.com>
Date: Mon, 1 May 2017 14:49:50 +0200
Subject: [PATCH 140/140] LDAP/AD: Do not fail in case
 rfc2307bis_nested_groups_recv() returns ENOENT
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Commit 25699846 introduced a regression seen when an initgroup lookup is
done and there's no nested groups involved.

In this scenario the whole lookup fails due to an ENOENT returned by
rfc2307bis_nested_groups_recv(), which leads to the user removal from
sysdb causing some authentication issues.

Resolves:
https://pagure.io/SSSD/sssd/issue/3331

Signed-off-by: Fabiano FidÃªncio <fidencio@redhat.com>
Reviewed-by: Sumit Bose <sbose@redhat.com>
(cherry picked from commit df4b24bed15f45bf286fb0102fd397218fdd4186)
(cherry picked from commit 4540d9f6817c78eef7b6e2d79245434811b59ad9)
(cherry picked from commit 2226d40da26da4ed406ba46a5ef16a16ae3ab973)
---
 src/providers/ldap/sdap_async_initgroups_ad.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/providers/ldap/sdap_async_initgroups_ad.c b/src/providers/ldap/sdap_async_initgroups_ad.c
index feb66aab9d95c79ea86c49ca7e63b1a3aad46869..e281580e1498c0616468a05a1d313247e3e866be 100644
--- a/src/providers/ldap/sdap_async_initgroups_ad.c
+++ b/src/providers/ldap/sdap_async_initgroups_ad.c
@@ -1740,7 +1740,13 @@ static void sdap_ad_get_domain_local_groups_done(struct tevent_req *subreq)
 
     ret = rfc2307bis_nested_groups_recv(subreq);
     talloc_zfree(subreq);
-    if (ret != EOK) {
+    if (ret == ENOENT) {
+        /* In case of ENOENT we can just proceed without making
+         * sdap_get_initgr_user() fail because there's no nested
+         * groups for this user/group. */
+        ret = EOK;
+        goto done;
+    } else if (ret != EOK) {
         tevent_req_error(req, ret);
         return;
     }
-- 
2.14.3

