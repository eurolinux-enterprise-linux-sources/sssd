From 9524b684806c9b0a291296334698c0ea2ba12cce Mon Sep 17 00:00:00 2001
From: Sumit Bose <sbose@redhat.com>
Date: Fri, 8 Apr 2016 18:43:57 +0200
Subject: [PATCH 87/89] sss_override: only add domain if name is not fully
 qualified
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Resolves:
https://fedorahosted.org/sssd/ticket/2989

Reviewed-by: Lukáš Slebodník <lslebodn@redhat.com>
(cherry picked from commit e45096aead1d2e2b8f8b2b386b420c5f62ad07d3)
---
 src/tools/sss_override.c | 28 +++++++++++++++++++++++++++-
 1 file changed, 27 insertions(+), 1 deletion(-)

diff --git a/src/tools/sss_override.c b/src/tools/sss_override.c
index 0e588a4341c17ba22ddb4e33aee55ebb9e1d6eea..187f4622f24ea8e0a1ee5f624ac0ac44212a962f 100644
--- a/src/tools/sss_override.c
+++ b/src/tools/sss_override.c
@@ -381,11 +381,37 @@ static char *get_fqname(TALLOC_CTX *mem_ctx,
     char *fqname;
     int fqlen;
     int check;
+    char *dummy_domain = NULL;
+    int ret;
 
-    if (domain == NULL) {
+    if (domain == NULL || domain->names == NULL) {
         return NULL;
     }
 
+    /* check if the name already contains domain part */
+    ret = sss_parse_name(mem_ctx, domain->names, name, &dummy_domain, NULL);
+    if (ret == ERR_REGEX_NOMATCH) {
+        DEBUG(SSSDBG_TRACE_FUNC,
+              "sss_parse_name could not parse domain from [%s]. "
+              "Assuming it is not FQDN.\n", name);
+    } else if (ret != EOK) {
+        DEBUG(SSSDBG_TRACE_FUNC,
+              "sss_parse_name failed [%d]: %s\n", ret, sss_strerror(ret));
+        return NULL;
+    }
+
+    if (dummy_domain != NULL) {
+        talloc_free(dummy_domain);
+        DEBUG(SSSDBG_TRACE_FUNC, "Name is already fully qualified.\n");
+        fqname = talloc_strdup(mem_ctx, name);
+        if (fqname == NULL) {
+            DEBUG(SSSDBG_CRIT_FAILURE, "talloc_strdup failed.\n");
+            return NULL;
+        }
+
+        return fqname;
+    }
+
     /* Get length. */
     fqlen = sss_fqname(NULL, 0, domain->names, domain, name);
     if (fqlen > 0) {
-- 
2.7.4

