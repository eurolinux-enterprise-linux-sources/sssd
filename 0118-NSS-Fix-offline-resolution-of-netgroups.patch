From 7a2367e84f38684bde42a6111dde346e297b24a8 Mon Sep 17 00:00:00 2001
From: Jakub Hrozek <jhrozek@redhat.com>
Date: Thu, 4 Aug 2016 17:58:47 +0200
Subject: [PATCH 118/119] NSS: Fix offline resolution of netgroups
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

If talking to the Data Provider failed, we never re-tried looking into
the cache. We should consult the cache on DP failures and return cached
results, if possible.

Resolves:
https://fedorahosted.org/sssd/ticket/3123

Reviewed-by: Pavel BÅ™ezina <pbrezina@redhat.com>
(cherry picked from commit a3108c5cd1ebb05c133c8e8990278ac4f4b8e25c)
---
 src/responder/nss/nsssrv_netgroup.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/responder/nss/nsssrv_netgroup.c b/src/responder/nss/nsssrv_netgroup.c
index 383b44a2c9b1fb87d3abfdce071b226a561e22a7..ee99b228e4bbf897b3f4377a8d09fadb07e71680 100644
--- a/src/responder/nss/nsssrv_netgroup.c
+++ b/src/responder/nss/nsssrv_netgroup.c
@@ -662,6 +662,15 @@ static void lookup_netgr_dp_callback(uint16_t err_maj, uint32_t err_min,
                   "Error: %u, %u, %s\n"
                   "Will try to return what we have in cache\n",
                   (unsigned int)err_maj, (unsigned int)err_min, err_msg);
+
+        /* Try to fall back to cache */
+        ret = lookup_netgr_step(step_ctx);
+        if (ret == EOK) {
+            /* We have cached results to return */
+            nss_setent_notify_done(dctx->netgr);
+            return;
+        }
+
         /* Loop to the next domain if possible */
         if (cmdctx->check_next
                 && (dctx->domain = get_next_domain(dctx->domain, 0))) {
-- 
2.7.4

