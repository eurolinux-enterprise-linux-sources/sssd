From 9894fbe5c867b1dbf4eb6f7d29c60c0af8f7421e Mon Sep 17 00:00:00 2001
From: Jakub Hrozek <jhrozek@redhat.com>
Date: Thu, 4 Aug 2016 17:58:32 +0200
Subject: [PATCH 102/102] AUTOFS: Fix offline resolution of autofs maps
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

If talking to the Data Provider failed, we never re-tried looking into
the cache. We should consult the cache on DP failures and return cached
results, if possible.

Resolves:
https://fedorahosted.org/sssd/ticket/3080

Reviewed-by: Pavel BÅ™ezina <pbrezina@redhat.com>
(cherry picked from commit b9e155da725e711ab306ca8a96e3ba6fbda41a3a)
---
 src/responder/autofs/autofssrv_cmd.c | 16 ++++++++++++----
 1 file changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/responder/autofs/autofssrv_cmd.c b/src/responder/autofs/autofssrv_cmd.c
index 42754aceb0d6999995b7d4dd17b196a785a2550c..4764f9ba52124c05a7a3be67e011ba33995f46b7 100644
--- a/src/responder/autofs/autofssrv_cmd.c
+++ b/src/responder/autofs/autofssrv_cmd.c
@@ -864,17 +864,25 @@ static void lookup_automntmap_cache_updated(uint16_t err_maj, uint32_t err_min,
     if (err_maj) {
         DEBUG(SSSDBG_CRIT_FAILURE,
               "Unable to get information from Data Provider\n"
-               "Error: %u, %u, %s\n"
-               "Will try to return what we have in cache\n",
+              "Error: %u, %u, %s\n"
+              "Will try to return what we have in cache\n",
                (unsigned int)err_maj, (unsigned int)err_min, err_msg);
-        /* Loop to the next domain if possible */
+
+        /* Try to fall back to cache */
+        ret = lookup_automntmap_step(lookup_ctx);
+        if (ret == EOK) {
+            /* We have cached results to return */
+            autofs_setent_notify(lookup_ctx->map, ret);
+            return;
+        }
+
+        /* Otherwise try the next domain */
         if (dctx->cmd_ctx->check_next
                 && (dctx->domain = get_next_domain(dctx->domain, 0))) {
             dctx->check_provider = NEED_CHECK_PROVIDER(dctx->domain->provider);
         }
     }
 
-    /* ok the backend returned, search to see if we have updated results */
     ret = lookup_automntmap_step(lookup_ctx);
     if (ret != EOK) {
         if (ret == EAGAIN) {
-- 
2.7.4

